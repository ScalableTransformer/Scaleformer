\begin{algorithm}[!ht]
	\small
	\caption{O($L$) calculation of $S^{rel} \times V$}
	\label{alg:A_rel}
	\KwIn{$\phi(Q)$ tensor of shape $(L_Q, d)$}
	\NextInput{$\phi(RP)$ tensor of shape $(2k+1, d)$}
	\NextInput{$V$ tensor of shape $(L_K, d)$}
	\vskip12pt
	\KwData{$W$ tensor of shape $(L_Q, 2k+1)$}
	\NextData{$Cumulated$ tensor of shape $(L_Q, d)$}
	\NextData{$Summed$ tensor of shape $(d)$}
	\NextData{$Rcum$ tensor of shape $(L_Q, d)$}
	\NextData{$W^{horizon}$ tensor of shape $(L_Q, 2k-1)$}
	\NextData{$V^{horizon}$ tensor of shape $(L_Q, 2k-1, d)$}
	\NextData{$W^{before/after}$ vectors of length $L_Q$}
	\NextData{$V^{before/after}$ tensors of shape $(L_Q, d)$}
	\NextData{$A^{before/horizon/after}$ tensors of shape $(L_Q, d)$}
	\NextData{$n_{before} := min(k, L_Q)$, scalar}
	\NextData{$n_{after} := min(L_Q+k, L_K)$, scalar}
	\vskip12pt
	\KwResult{$A^{rel}$ tensor of shape $(L_Q, d)$}
	\vskip12pt
	$W := \phi(Q) \times \phi(RP)^T$\\
	$Cumulated := cumsum(V, dim=0)$\\
	$W^{before}_{i} := W_{i,0}$\\
	$V^{before}_{ij} := 
	\begin{cases}
		0 & \text{if }i < n_{before}\\
		Cumulated_{i-p_{before}, j} & otherwise\\
	\end{cases}$\\
	$A^{before}_{ij} := W^{before}_{i} \times V^{before}_{ij}$\\
	$W^{horizon}_{ij} := W_{i+1,j}$\\
	$V^{horizon}_{ijl} :=
	\begin{cases}
		V_{i-k+1+j, l} & \text{if }0 \leq (i-k+1+j) < L_K\\
		0 & \text{otherwise} 
	\end{cases}$\\
	$A^{horizon}_{il} := \sum_j \left( W^{horizon}_{ij} \times V^{horizon}_{ijl} \right)$\\
	$Summed_{j} := \sum_i \left( V_{ij}\right)$\\
	$Rcum_{ij} := 
	\begin{cases}
		Summed_{j} & \text{if }i=0\\
		Summed_{j} - Cumulated_{i-1,j} & otherwise
	\end{cases}$\\
	$W^{after}_{i} := W_{i, 2k}$\\
	$V^{after}_{ij} := 
	\begin{cases}
		Rcum_{i+k-1,j} & \text{if }i<n_{after}\\
		0 & otherwise
	\end{cases}$\\
	$A^{after}_{ij} := W^{after}_{i} \times V^{after}_{ij}$\\
	$A^{rel}_{ij} := A^{before}_{ij} + A^{horizon}_{ij} + A^{after}_{ij}$
\end{algorithm}

\endinput