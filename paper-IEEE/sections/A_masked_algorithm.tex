\begin{algorithm}[!h]
	\small
	\caption{O($L$) calculation of \resizebox{0.35\hsize}{!}{$\mathrm{masked} \left( \phi(Q) \times \phi(K)^T \right) \times V$}}
	\label{alg:A_masked}
	\KwIn{$\phi(Q)$ tensor of shape $(L_Q, d)$}
	\NextInput{$\phi(K)$ tensor of shape $(L_K, d)$}
	\NextInput{$V$ tensor of shape $(L_K, d)$}
	\vskip12pt
	\KwData{Expanded tensor of shape $(L_K, d, d)$}
	\NextData{Summed tensor of shape $(L_K, d, d)$}
	\NextData{Aligned tensor of shape $(L_Q, d, d)$}
	\vskip12pt
	\KwResult{$A^{masked}$ tensor of shape $(L_Q, d)$}
	\vskip12pt
	$\text{Expanded}_{kjl} := V_{kj} \times \phi(K)_{kl}$\\
	$\text{Summed} := cumsum\left(\text{Expanded}, \text{dim=0}\right)$\\
	$\text{Aligned} := align(\text{Summed}, L_Q, \text{dim=0})$\\
	$A^{masked}_{ij} := \sum_k \left( \phi(Q)_{ik} \times \text{Aligned}_{ikj} \right)$
\end{algorithm}